---
title: "01_data_download"
author: "C.R."
date: "12/03/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 15, fig.height = 11)
library(tidyverse)
library(lubridate)
#devtools::install_github("CamembR/tdvhackaviz2020")
library(tdvhackaviz2020)
library(here)
library(skimr)
library(tsibble)
library(dygraphs)
library(xts)
# library(timetk)
library(ggridges)
library(plotly)
```

## Capacité et usage des hébergements touristiques

```{r capacite hebergement}
#skim(force(capacites)) # n'amène rien sur une time series au format long
summary(force(capacites))
# TODO c'est une time-série, on fera un petit ridge-line plot: https://www.data-to-viz.com/graph/ridgeline.html
hebergement_ts <- force(capacites) %>%
  select(dep,starts_with("sem_")) %>% 
  mutate(sem_53 = 7*sem_53, dep = as.factor(dep)) %>% # la derniere semaine ne fait qu'une journee, ça fait tâche sur les graphes
  pivot_longer(-dep, names_to = "semaine", names_prefix = "sem_", values_to="touristes") %>%
  mutate_at("semaine",as.numeric) %>% 
  mutate(date = ymd("2018-01-01")+(semaine-1)*7) %>% 
  as_tsibble(index=date, key=dep)
# on plot pour voir
ggplot(hebergement_ts)+
  geom_line(aes(x=date,y=touristes/1e6, color=dep), size=1)+
  scale_fill_continuous(guide = guide_legend()) +
  theme_minimal()+
  theme(legend.position="bottom") +
  ggtitle("Capacité occupée par departement et par semaine") + ylab("Nombre de touristes (Millions) par semaine")
# le meme en ridge line plot
ggplot(hebergement_ts)+
  geom_ridgeline( aes(x = date, height = touristes/1e6, y = fct_reorder(dep,touristes)), alpha=0.7) +
  scale_fill_continuous(guide = guide_legend()) +
  theme(legend.position="bottom") +
  ggtitle("Mais qui dors ou et quand ?", subtitle ="Occupation des hébergements touristiques par departement") + ylab("Nombre de touristes par semaine (Millions) ")

```
Un ordre s'impose parmi les départements pour rendre ça beau... Ici, c'est l'ordre imposé par le nombre de touristes qui s'applique. On voit une difference entre les departements à tourisme saisonnier et la haute-garonne

## Nuitées occuppées relativement à la capacité totale

Si on veut developper le tourisme, il faut remplir les trous... On a le total de capacité alors on y va
```{r}
hebergement_pcent_ts <-  force(capacites) %>%
  mutate(dpt = as.factor(dep)) %>% 
  group_by(dep) %>% 
  mutate_at(vars(starts_with("sem_")), ~./hbgt_total/7) %>% 
  select(dep,starts_with("sem_")) %>% 
  mutate(sem_53 = 7*sem_53) %>% # la derniere semaine ne fait qu'une journee, ça fait tache sur les graphes
  pivot_longer(-dep, names_to = "semaine", names_prefix = "sem_", values_to="touristes") %>%
  mutate_at("semaine",as.numeric) %>% 
  mutate(date = ymd("2018-01-01")+(semaine-1)*7) %>% 
  as_tsibble(index=date, key=dep)

```

Sont-ils bien tous des touristes ?
```{r}
ggplot(hebergement_pcent_ts)+
  geom_ridgeline( aes(x = date, height = touristes, y = fct_reorder(dep,touristes)), alpha=0.5, color="darkred", min_height = .5, scale=.5) +
  geom_ridgeline( aes(x = date, height = 1, y = fct_reorder(dep,touristes)), alpha=0.01, color="black", scale=.5, size=0.1) +
  scale_fill_continuous(guide = guide_legend()) +
  theme(legend.position="bottom") +
  ggtitle("Quelle saison touristique dans chaque département ?", subtitle="Occupation des hébergements touristiques par departement, 100 % représenté par la fine ligne noire, on ne représente pas en dessous de 50%") + ylab("Nombre de voyageurs par semaine (pourcent) ")
```
Hormis dans l'Aveyron et les Hautes Py., la capacité d'hébergement touristique est toujours dépassée. On a donc capturé ici des voyageurs qui ne sont pas des touristes.


## nuités.xlsx
```{r nuitées}
# skim(force(nuitees))# n'amène rien sur une time series au format long
summary(nuitees)
# TODO c'est une time-série, on fera un petit ridge-line plot: https://www.data-to-viz.com/graph/ridgeline.html
nuitee_ts <- nuitees_td %>% as_tsibble(index= date, key=dep)
ggplot(nuitee_ts)+
  geom_line(aes(x=date,y=`nuitees`, color=dep), size=1)+
  scale_fill_continuous(guide = guide_legend()) +
  theme_minimal()+
  theme(legend.position="bottom")
# les NA dans les valeurs rends impossible la comparaison entre nuités et le fct_reorder bouhhh
median_na <- function(x) {
  median(x,na.rm = TRUE)
}
# le meme en ridge line plot
ggplot(nuitee_ts)+
  geom_ridgeline( aes(x = date, height = nuitees/1e5, y = fct_reorder(dep, `nuitees`, .fun=median_na)), alpha=0.5) +
  scale_fill_continuous(guide = guide_legend()) +
  theme(legend.position="bottom")+
  ggtitle("nombre de nuitées (x100k)")

```

Il y a plusieurs accidents dans plein de départements simultanément.
Là encore même distingo entre le 31 et les autres departements.

Il y a une saisonnalité à la semaine qu'il faut relier aux évènements extérieurs

Est-ce qu'on peut imaginer un effet whaou sur un bubble plot animé style le fameux Gapminder ![Gapminder par gganimate](https://gganimate.com/reference/figures/README-unnamed-chunk-4-1.gif)  

```{r dygraph nuitées}
# apprends-t-on plus avec un zoom ?
nuiteplus <- nuitees %>% na_if(0) %>% 
  select(-total_occitanie) %>%
  timetk::tk_augment_timeseries_signature() %>%
  select(date, starts_with("dpt_"),jour_sem=wday.lbl) %>%
  xts(. , order.by = .$date)                                                                                                                            
dygraph(nuiteplus) %>% dyRangeSelector() %>%
  dyHighlight(highlightCircleSize = 5, 
              highlightSeriesBackgroundAlpha = 0.2,
              hideOnMouseOut = FALSE) %>% 
  dyLegend(width = 700, hideOnMouseOut = FALSE)
```


## Jeu de données par_origines 
```{r par_origines}
skim(par_origines)
# il y a des duplicates. impossible de le faire rentrer dans ne time-series sans les enlever !
origines_ts <- par_origines_td %>%
  ungroup %>% 
  mutate(dep_dest = fct_relevel(dep_dest, c("34","31","11","66","30","65","12","46","82","81","32","09","48"))) %>% 
  mutate_at("meteo",as.ordered) %>% 
  #group_by(date, dep_org, dep_dest) %>% summarise_all(~last(.)) %>% # filter duplicate
  as_tsibble(index= date, key=c("dep_org","dep_dest"))
# un petit facet-plot pour la route
ggvolume <-ggplot(origines_ts %>% filter(dep_org!="Autres"))+
  geom_line(aes(x=date,y=`volume`/1e3, color=dep_org), size=.4, alpha=.6)+
  facet_wrap("dep_dest") +
  scale_fill_continuous(guide = guide_legend()) + ylim(0,25) +
  ggtitle("Mais d'où viennent-ils", subtitle = "Origine identifiée des voyageurs dans chaque departement visité")+
  theme_minimal()+ theme(legend.position="none")+ scale_color_viridis_d(option="E") 
ggplotly(ggvolume)
# un petit facet-plot des temperatures (qui n'a aucun interêt)
ggplot(origines_ts )+
  geom_line(aes(x=date,y=temp_midi), color="navy", alpha=0.6)+
  facet_wrap("dep_dest") +
  scale_fill_continuous(guide = guide_legend()) +
  theme_minimal()+
  theme(legend.position="none")

```

Globalement, on n'y voit rien... Un phénomene intéressant d'une origine spécifique des voyageurs de loin  majoritaire en Haute-garonne... ~~~Va savoir laquelle sur un graphe, Charles...~~~ Avec plotly, on sait que c'est "Autres". Super Michel...

Si c'est intéressant, on pourrait faire des catégories aggrégées genre "dep_limitrophes", "dep_2éme_couronne", "dep_lointains", "pays_limitrophes", "pays_lointains", mais il y a un peu de boulot...

## Complements.

```{r complements}
evenements <- comp_evenements %>% 
  mutate_at("num", as.integer)
skim(evenements)
#on ajoute des quelques évenements nationnaux dans les pics remarquables
fr_evenemt <- tibble(dep = c("ts","ts" ),
                     evt = c("Rentrée scolaire","Gilets Jaunes A-1"),
                     deb = c("2018-09-04","2018-11-17") %>% ymd,
                     fin = c("2018-09-04","2018-11-18") %>% ymd
                     ) %>%
  mutate(dep = str_replace(dep,"ts","34-31-11-66-30-65-12-46-82-81-32-09-48")) %>%
  separate_rows(dep,sep="-")
evenements <- bind_rows(evenements, fr_evenemt)
```

